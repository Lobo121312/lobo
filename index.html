<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The UNM SOM Facebook - Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&family=Lobster&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .card {
            background-color: rgba(31, 41, 55, 0.5); /* bg-gray-800 with transparency */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .photo-tile .name-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            transition: opacity 0.4s ease-in-out;
        }
        .photo-tile:hover .name-overlay {
            opacity: 1;
        }
        .photo-tile .admin-overlay {
            transition: opacity 0.3s ease-in-out;
        }
         .photo-tile:hover .admin-overlay {
            opacity: 1;
        }
        .photo-tile-verify {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .photo-tile-verify:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 0 4px rgba(96, 165, 250, 0.5); /* blue-400 */
        }
        .fancy-btn {
            background-image: linear-gradient(to right, #3b82f6 0%, #8b5cf6 51%, #3b82f6 100%);
            background-size: 200% auto;
            transition: background-position 0.5s;
        }
        .fancy-btn:hover {
            background-position: right center;
        }
        .fancy-header {
            font-family: 'Playfair Display', serif;
        }
        .leaderboard-header {
            font-family: 'Lobster', cursive;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
        }
        .section-header:focus-visible {
            outline: 2px solid #8b5cf6; /* purple-500 */
            outline-offset: 4px;
            border-radius: 8px;
        }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="min-h-screen w-full flex flex-col items-center justify-center p-4 bg-dots-pattern">

        <!-- Verification Step 1: Enter Name -->
        <div id="verify-step-1" class="w-full max-w-md fade-in">
            <div class="card p-8 rounded-2xl shadow-2xl text-center">
                <p class="text-xl text-gray-300 mb-2">Welcome to</p>
                <h1 class="text-5xl font-bold fancy-header leading-tight mb-4">
                    <div><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">The</span></div>
                    <div>
                        <span style="color: #800020;">UNM</span>
                        <span class="text-gray-400"> SOM</span>
                    </div>
                    <div><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Facebook</span></div>
                </h1>
                <div class="mb-8">
                    <p class="text-gray-400">A tool to help you remember the names of your fellow classmates. For UNM SOM students only.</p>
                    <p class="text-gray-400 mt-4">Please enter your first and last name to continue.</p>
                </div>
                <form id="name-form" class="space-y-6">
                    <input type="text" id="name-input" class="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-300">
                    <button type="submit" class="w-full fancy-btn text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg transition-shadow duration-300">
                        Continue
                    </button>
                </form>
            </div>
        </div>

        <!-- Verification Step 2: Pick Your Face -->
        <div id="verify-step-2" class="w-full max-w-4xl hidden">
            <div class="card p-8 rounded-2xl shadow-2xl text-center fade-in">
                <h1 class="text-3xl font-bold text-white mb-2">Security Check</h1>
                <p class="text-gray-400 mb-8">Confirm your identity by selecting your photo.</p>
                <div id="photo-options-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">
                    <!-- Photo options will be injected here by JS -->
                </div>
                 <button id="back-to-step-1" class="mt-8 text-sm text-gray-500 hover:text-blue-400 transition-colors">Entered the wrong name?</button>
            </div>
        </div>

        <!-- Main Directory -->
        <div id="directory" class="w-full max-w-7xl hidden">
            <div class="card p-4 sm:p-8 rounded-2xl shadow-2xl fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-6">
                    <h1 class="text-5xl font-bold fancy-header">
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">The </span>
                        <span style="color: #800020;">UNM</span>
                        <span class="text-gray-400"> SOM</span>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500"> Facebook</span>
                    </h1>
                    <button id="logout-button" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700 transition-colors duration-300 shadow-md hover:shadow-lg mt-4 sm:mt-0">
                        Logout
                    </button>
                </div>

                <div id="admin-controls" class="hidden mb-8">
                    <div class="flex flex-col sm:flex-row gap-4">
                         <input type="text" id="search-input" placeholder="Search by name to filter..." class="flex-grow px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500">
                         <button id="add-person-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors duration-300">Add New Person</button>
                    </div>
                </div>

                <div id="directory-content">
                    <!-- Directory content will be injected here by JS -->
                </div>
                 <div id="footer" class="text-center text-gray-500 text-xs mt-12 pt-6 border-t border-gray-700">
                    This website was fully vibe-coded by Jake Kerner. Click my picture in the MD Class of 2027 three times to request a change to your name or picture.
                </div>
            </div>
        </div>

        <!-- Modals Container -->
        <div id="modal-container"></div>
    </div>

    <script>
        // --- DATA ---
        let allPeople = [
            // MD Class of 2026
            { id: 6, name: "Priya Patel", type: 'student', classYear: 'MD Class of 2026', imageUrl: 'https://placehold.co/400x400/14b8a6/ffffff?text=Priya' },
            { id: 7, name: "David Chen", type: 'student', classYear: 'MD Class of 2026', imageUrl: 'https://placehold.co/400x400/f97316/ffffff?text=David' },
            { id: 8, name: "Sophia Rodriguez", type: 'student', classYear: 'MD Class of 2026', imageUrl: 'https://placehold.co/400x400/475569/ffffff?text=Sophia' },
            { id: 9, name: "Ben Carter", type: 'student', classYear: 'MD Class of 2026', imageUrl: 'https://placehold.co/400x400/78716c/ffffff?text=Ben' },
            { id: 10, name: "Olivia Martinez", type: 'student', classYear: 'MD Class of 2026', imageUrl: 'https://placehold.co/400x400/d946ef/ffffff?text=Olivia' },
            // MD Class of 2027
            { id: 11, name: "Jake Kerner", type: 'student', classYear: 'MD Class of 2027', imageUrl: 'https://placehold.co/400x400/ec4899/ffffff?text=Jake' },
            // MD Class of 2028
            { id: 12, name: "Liam Brown", type: 'student', classYear: 'MD Class of 2028', imageUrl: 'https://placehold.co/400x400/f43f5e/ffffff?text=Liam' },
            { id: 13, name: "Ava Davis", type: 'student', classYear: 'MD Class of 2028', imageUrl: 'https://placehold.co/400x400/84cc16/ffffff?text=Ava' },
            { id: 14, name: "Noah Miller", type: 'student', classYear: 'MD Class of 2028', imageUrl: 'https://placehold.co/400x400/10b981/ffffff?text=Noah' },
            { id: 15, name: "Isabella Wilson", type: 'student', classYear: 'MD Class of 2028', imageUrl: 'https://placehold.co/400x400/06b6d4/ffffff?text=Isabella' },
            { id: 16, name: "Mason Moore", type: 'student', classYear: 'MD Class of 2028', imageUrl: 'https://placehold.co/400x400/a78bfa/ffffff?text=Mason' },
            // MD Class of 2029
            { id: 17, name: "Harper Taylor", type: 'student', classYear: 'MD Class of 2029', imageUrl: 'https://placehold.co/400x400/fbbf24/ffffff?text=Harper' },
            { id: 18, name: "Ethan Anderson", type: 'student', classYear: 'MD Class of 2029', imageUrl: 'https://placehold.co/400x400/60a5fa/ffffff?text=Ethan' },
            { id: 19, name: "Amelia Thomas", type: 'student', classYear: 'MD Class of 2029', imageUrl: 'https://placehold.co/400x400/f87171/ffffff?text=Amelia' },
            { id: 20, name: "Logan Jackson", type: 'student', classYear: 'MD Class of 2029', imageUrl: 'https://placehold.co/400x400/4ade80/ffffff?text=Logan' },
            { id: 21, name: "Mia Harris", type: 'student', classYear: 'MD Class of 2029', imageUrl: 'https://placehold.co/400x400/c084fc/ffffff?text=Mia' },
        ];

        // --- STATE MANAGEMENT ---
        let userToVerify = null;
        let isAdmin = false;
        let loginCounts = {};
        let tileClickCounts = {};
        let sessionInteractedTiles = new Set();
        let sessionForgetfulWinner = null;
        let sessionForgettableWinner = null;

        // --- DOM ELEMENTS ---
        const verifyStep1 = document.getElementById('verify-step-1');
        const verifyStep2 = document.getElementById('verify-step-2');
        const directory = document.getElementById('directory');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name-input');
        const photoOptionsGrid = document.getElementById('photo-options-grid');
        const directoryContent = document.getElementById('directory-content');
        const logoutButton = document.getElementById('logout-button');
        const adminControls = document.getElementById('admin-controls');
        const addPersonBtn = document.getElementById('add-person-btn');
        const searchInput = document.getElementById('search-input');
        const backToStep1Button = document.getElementById('back-to-step-1');
        const modalContainer = document.getElementById('modal-container');

        // --- MODAL FUNCTIONS ---
        function showModal(type, data = {}) {
            modalContainer.innerHTML = ''; // Clear previous modals
            let modalContent = '';

            switch(type) {
                case 'error':
                    modalContent = createErrorModal(data.title, data.message);
                    break;
                case 'request-change':
                     modalContent = createRequestChangeModal();
                     break;
                case 'add-edit':
                    modalContent = createAddEditModal(data.person);
                    break;
                case 'delete-confirm':
                    modalContent = createDeleteConfirmModal(data.person);
                    break;
            }
            
            modalContainer.innerHTML = modalContent;
            document.body.style.overflow = 'hidden';
            
            const closeAction = data.onClose || closeModal;

            const modalBg = modalContainer.querySelector('.modal-bg');
            if (modalBg) modalBg.addEventListener('click', closeAction);

            const modalCard = modalContainer.querySelector('.modal-content-card');
            if (modalCard) modalCard.addEventListener('click', (e) => e.stopPropagation());
            
            const closeModalBtn = modalContainer.querySelector('.close-modal-btn');
            if(closeModalBtn) closeModalBtn.addEventListener('click', closeAction);

            const form = modalContainer.querySelector('form');
            if(form) form.addEventListener('submit', data.onSubmit);

            if (type === 'delete-confirm') {
                const confirmBtn = modalContainer.querySelector('#confirm-delete-btn');
                if (confirmBtn) confirmBtn.onclick = data.onConfirm;
            }
        }

        function closeModal() {
            modalContainer.innerHTML = '';
            document.body.style.overflow = 'auto';
        }

        function createErrorModal(title, message) {
             return `
            <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 modal-bg">
                <div class="card modal-content-card p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full border-red-500/50 fade-in">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50">
                        <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <h3 class="text-xl leading-6 font-medium text-white mt-5">${title || 'Error'}</h3>
                    <div class="mt-2 px-4"><p class="text-sm text-gray-400">${message || 'An unknown error occurred.'}</p></div>
                    <div class="mt-6"><button class="close-modal-btn w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700">Close</button></div>
                </div>
            </div>`;
        }
        
        function createRequestChangeModal() {
             return `
            <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 modal-bg">
                <div class="card modal-content-card p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full border-blue-500/50 fade-in">
                    <h3 class="text-xl leading-6 font-medium text-white mt-5">Request a Change</h3>
                    <div class="mt-2 px-4"><p class="text-sm text-gray-400">To request a change to your name or photo, please contact Jake Kerner at JKerner@health.unm.edu.</p></div>
                    <div class="mt-6"><button class="close-modal-btn w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">Got it</button></div>
                </div>
            </div>`;
        }

        function createAddEditModal(person = null) {
            const isEditing = person !== null;
            const title = isEditing ? 'Edit Person' : 'Add New Person';
            const classYears = ['MD Class of 2026', 'MD Class of 2027', 'MD Class of 2028', 'MD Class of 2029'];
            
            const classYearOptions = classYears.map(year => 
                `<option value="${year}" ${person && person.classYear === year ? 'selected' : ''}>${year}</option>`
            ).join('');

            return `
            <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 modal-bg">
                 <div class="card modal-content-card p-8 rounded-2xl shadow-2xl text-left max-w-lg w-full fade-in">
                     <h3 class="text-2xl font-bold text-white mb-6">${title}</h3>
                     <form id="add-edit-form" class="space-y-4">
                         <input type="hidden" name="id" value="${person ? person.id : ''}">
                         <div>
                             <label for="name" class="block text-sm font-medium text-gray-300">Full Name</label>
                             <input type="text" name="name" id="name" value="${person ? person.name : ''}" required class="mt-1 w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white">
                         </div>
                         <div>
                             <label for="imageUpload" class="block text-sm font-medium text-gray-300">Upload Image</label>
                             <input type="file" name="imageUpload" id="imageUpload" accept="image/*" class="mt-1 w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                         </div>
                         <div>
                             <label for="classYear" class="block text-sm font-medium text-gray-300">Class Year</label>
                             <select name="classYear" id="classYear" class="mt-1 w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg text-white">
                                 ${classYearOptions}
                             </select>
                         </div>
                         <div class="pt-4 flex justify-end gap-4">
                            <button type="button" class="close-modal-btn bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700">Cancel</button>
                            <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700">Save</button>
                         </div>
                     </form>
                 </div>
            </div>
            `;
        }

        function createDeleteConfirmModal(person) {
             return `
            <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 modal-bg">
                <div class="card modal-content-card p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full border-red-500/50 fade-in">
                    <h3 class="text-xl leading-6 font-medium text-white mt-5">Are you sure?</h3>
                    <div class="mt-2 px-4"><p class="text-sm text-gray-400">Do you really want to delete ${person.name}? This action cannot be undone.</p></div>
                    <div class="mt-6 flex justify-center gap-4">
                        <button class="close-modal-btn bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700">Cancel</button>
                        <button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700">Delete</button>
                    </div>
                </div>
            </div>`;
        }


        // --- MAIN FUNCTIONS ---
        function switchView(viewToShow) {
            [verifyStep1, verifyStep2, directory].forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
            viewToShow.classList.add('fade-in');
        }

        async function handleNameSubmit(event) {
            event.preventDefault();
            const inputName = nameInput.value.trim();
            
            if (inputName === 'AppleBottleSpikeYellow') {
                isAdmin = true;
                userToVerify = { name: 'Admin', id: -1 };
            } else {
                isAdmin = false;
                userToVerify = allPeople.find(p => p.name.toLowerCase() === inputName.toLowerCase());
            }

            if (userToVerify) {
                if (userToVerify.name !== 'Admin') {
                    loginCounts[userToVerify.name] = (loginCounts[userToVerify.name] || 0) + 1;
                }
                setLeaderboardWinnersForSession();
                sessionInteractedTiles.clear();

                if (isAdmin) {
                    renderDirectory();
                    switchView(directory);
                    adminControls.classList.remove('hidden');
                } else {
                    setupVerificationStep2();
                    switchView(verifyStep2);
                }
            } else {
                showModal('error', { title: 'Login Failed', message: "Name not found. Please check the spelling." });
            }
        }

        function setupVerificationStep2() {
            const otherPeople = allPeople.filter(p => p.id !== userToVerify.id);
            const randomSample = [];
            const usedIndexes = new Set();
            while(randomSample.length < 9 && randomSample.length < otherPeople.length) {
                const randomIndex = Math.floor(Math.random() * otherPeople.length);
                if (!usedIndexes.has(randomIndex)) {
                    randomSample.push(otherPeople[randomIndex]);
                    usedIndexes.add(randomIndex);
                }
            }
            const verificationOptions = [...randomSample, userToVerify].sort(() => Math.random() - 0.5);
            photoOptionsGrid.innerHTML = '';
            verificationOptions.forEach(person => {
                const tile = document.createElement('div');
                tile.className = 'photo-tile-verify cursor-pointer rounded-lg overflow-hidden shadow-lg';
                tile.innerHTML = `<img src="${person.imageUrl}" alt="Verification photo" class="w-full h-full object-cover">`;
                tile.onclick = () => handlePhotoSelection(person);
                photoOptionsGrid.appendChild(tile);
            });
        }

        function handlePhotoSelection(selectedPerson) {
            if (selectedPerson.id === userToVerify.id) {
                renderDirectory();
                switchView(directory);
            } else {
                showModal('error', { title: 'Login Failed', message: "That's not the right photo. Access denied.", onClose: resetToStep1 });
            }
        }
        
        function renderDirectory(searchTerm = '') {
            directoryContent.innerHTML = '';
            const studentsByYear = allPeople
                .filter(p => p.type === 'student')
                .reduce((acc, student) => {
                    (acc[student.classYear] = acc[student.classYear] || []).push(student);
                    return acc;
                }, {});
            
            const sortedYears = Object.keys(studentsByYear).sort().reverse();
            
            sortedYears.forEach(year => {
                directoryContent.innerHTML += createSection(year, studentsByYear[year], false);
            });
            
            directoryContent.innerHTML += createFacultySection(false);
            directoryContent.innerHTML += createLeaderboardSection(false);

            if (isAdmin && searchTerm) {
                 handleSearch(searchTerm, true);
            }
        }

        function createSection(title, people, isInitiallyOpen) {
            const contentId = `section-content-${title.replace(/\s+/g, '-')}`;
            
            const shuffledPeople = [...people].sort(() => Math.random() - 0.5);

            const peopleTiles = shuffledPeople.map(person => `
                <div data-person-id="${person.id}" data-person-name="${person.name}" class="photo-tile group relative rounded-lg overflow-hidden shadow-lg text-left w-full cursor-pointer" role="button" tabindex="0">
                    <img src="${person.imageUrl}" alt="${person.name}" class="w-full h-auto object-cover aspect-square group-hover:scale-110 transition-transform duration-400">
                    <div class="name-overlay absolute inset-0 flex items-end justify-start p-4 opacity-0 pointer-events-none">
                        <span class="text-white font-bold text-lg">${person.name}</span>
                    </div>
                    ${isAdmin ? `
                    <div class="admin-overlay absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 flex gap-1">
                        <button class="edit-btn bg-blue-600/80 text-white text-xs p-1 rounded-md hover:bg-blue-500" data-id="${person.id}">Edit</button>
                        <button class="delete-btn bg-red-600/80 text-white text-xs p-1 rounded-md hover:bg-red-500" data-id="${person.id}">Del</button>
                    </div>
                    ` : ''}
                </div>
            `).join('');

            return `
                <div class="collapsible-section border-b border-gray-700 last:border-b-0" data-open="${isInitiallyOpen}">
                    <button class="section-header w-full flex justify-between items-center text-left py-6" aria-expanded="${isInitiallyOpen}" aria-controls="${contentId}">
                        <h2 class="text-3xl font-bold text-white fancy-header">${title}</h2>
                        <svg class="chevron-icon w-6 h-6 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="${contentId}" class="section-content overflow-hidden transition-all duration-500 ease-in-out" style="max-height: 0px">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 pb-8">
                            ${peopleTiles}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createFacultySection(isInitiallyOpen) {
            const title = 'Faculty Directory';
            const contentId = `section-content-faculty`;
            return `
                <div class="collapsible-section border-b border-gray-700 last:border-b-0" data-open="${isInitiallyOpen}">
                    <button class="section-header w-full flex justify-between items-center text-left py-6" aria-expanded="${isInitiallyOpen}" aria-controls="${contentId}">
                        <h2 class="text-3xl font-bold text-white fancy-header">${title}</h2>
                        <svg class="chevron-icon w-6 h-6 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="${contentId}" class="section-content overflow-hidden transition-all duration-500 ease-in-out" style="max-height: 0px">
                       <div class="pb-8">
                         <iframe src="https://hsc.unm.edu/directory/" class="w-full h-[80vh] rounded-lg border border-gray-600" title="Live Faculty Directory"></iframe>
                       </div>
                    </div>
                </div>
            `;
        }

        function createLeaderboardSection(isInitiallyOpen) {
            const title = 'Leaderboard';
            const contentId = 'section-content-leaderboard';
            const leaderboardContent = `
                <div class="flex flex-col md:flex-row justify-center gap-8 md:gap-16 text-center pb-8">
                    <div class="flex flex-col items-center">
                         <h3 class="text-2xl font-bold text-purple-400 mb-2">Most Forgetful</h3>
                         <p class="text-gray-400 mb-4">(Most logins)</p>
                         <div id="most-forgetful-winner"><p class="text-gray-500">No data yet.</p></div>
                    </div>
                    <div class="flex flex-col items-center">
                         <h3 class="text-2xl font-bold text-cyan-400 mb-2">Most Forgettable</h3>
                         <p class="text-gray-400 mb-4">(Most profile interactions)</p>
                         <div id="most-forgettable-winner"><p class="text-gray-500">No data yet.</p></div>
                    </div>
                </div>
            `;

            return `
                 <div class="collapsible-section" data-open="${isInitiallyOpen}">
                    <button class="section-header w-full flex justify-between items-center text-left py-6" aria-expanded="${isInitiallyOpen}" aria-controls="${contentId}">
                        <h2 class="text-4xl font-bold text-white leaderboard-header">${title}</h2>
                        <svg class="chevron-icon w-6 h-6 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="${contentId}" class="section-content overflow-hidden transition-all duration-500 ease-in-out" style="max-height: 0px">
                       ${leaderboardContent}
                    </div>
                </div>
            `;
        }
        
        function setLeaderboardWinnersForSession() {
            const students = allPeople.filter(p => p.type === 'student');
            if (students.length > 0) {
                let randIndex1 = Math.floor(Math.random() * students.length);
                let randIndex2 = Math.floor(Math.random() * students.length);
                while(randIndex1 === randIndex2 && students.length > 1) {
                    randIndex2 = Math.floor(Math.random() * students.length);
                }
                sessionForgetfulWinner = students[randIndex1];
                sessionForgettableWinner = students[randIndex2];
            }
        }

        function updateLeaderboard() {
            const forgetfulWinnerDiv = document.getElementById('most-forgetful-winner');
            const forgettableWinnerDiv = document.getElementById('most-forgettable-winner');
            
            if (sessionForgetfulWinner) {
                forgetfulWinnerDiv.innerHTML = `<img src="${sessionForgetfulWinner.imageUrl}" alt="${sessionForgetfulWinner.name}" class="w-40 h-40 rounded-full object-cover border-4 border-purple-500 shadow-lg mb-4"><p class="text-xl font-semibold text-white">${sessionForgetfulWinner.name}</p>`;
            } else {
                 forgetfulWinnerDiv.innerHTML = `<p class="text-gray-500">No data yet.</p>`;
            }
            
            if (sessionForgettableWinner) {
                forgettableWinnerDiv.innerHTML = `<img src="${sessionForgettableWinner.imageUrl}" alt="${sessionForgettableWinner.name}" class="w-40 h-40 rounded-full object-cover border-4 border-cyan-500 shadow-lg mb-4"><p class="text-xl font-semibold text-white">${sessionForgettableWinner.name}</p>`;
            } else {
                 forgettableWinnerDiv.innerHTML = `<p class="text-gray-500">No data yet.</p>`;
            }
        }
        
        function incrementForgettableCounter(tile) {
            if (!tile) return;
            const personId = parseInt(tile.dataset.personId, 10);
            if (sessionInteractedTiles.has(personId)) {
                return; 
            }
            const person = allPeople.find(p => p.id === personId);
            if (person) {
                tileClickCounts[person.name] = (tileClickCounts[person.name] || 0) + 1;
                sessionInteractedTiles.add(personId);
            }
        }

        function handleSectionToggle(event) {
            const header = event.target.closest('.section-header');
            if (!header) return;

            const section = header.closest('.collapsible-section');
            const content = section.querySelector('.section-content');
            const icon = header.querySelector('.chevron-icon');
            const isOpen = section.getAttribute('data-open') === 'true';
            
            if (content.id === 'section-content-leaderboard' && !isOpen) {
                updateLeaderboard();
            }

            if (isOpen) {
                content.style.maxHeight = '0px';
                icon.classList.remove('rotate-180');
                section.setAttribute('data-open', 'false');
                header.setAttribute('aria-expanded', 'false');
            } else {
                const isIframeSection = content.querySelector('iframe');
                content.style.maxHeight = isIframeSection ? '5000px' : content.scrollHeight + 'px';
                icon.classList.add('rotate-180');
                section.setAttribute('data-open', 'true');
                header.setAttribute('aria-expanded', 'true');
            }
        }
        
        async function handleAdminFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const id = form.elements.id.value ? parseInt(form.elements.id.value) : null;
            const name = form.elements.name.value;
            const classYear = form.elements.classYear.value;
            const imageUpload = form.elements.imageUpload.files[0];

            let imageUrl;

            if (imageUpload) {
                imageUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageUpload);
                });
            } else if (id) {
                const existingPerson = allPeople.find(p => p.id === id);
                imageUrl = existingPerson.imageUrl;
            } else {
                 imageUrl = `https://placehold.co/400x400/cccccc/ffffff?text=${name.charAt(0)}`;
            }

            if(id) { // Editing existing person
                const personIndex = allPeople.findIndex(p => p.id === id);
                if(personIndex > -1) {
                    allPeople[personIndex] = { ...allPeople[personIndex], name, imageUrl, classYear };
                }
            } else { // Adding new person
                const newId = Math.max(...allPeople.map(p => p.id), 0) + 1;
                allPeople.push({ id: newId, name, imageUrl, classYear, type: 'student' });
            }
            renderDirectory(searchInput.value);
            closeModal();
        }

        function handleDeletePerson(id) {
            allPeople = allPeople.filter(p => p.id !== id);
            renderDirectory(searchInput.value);
            closeModal();
        }

        function handleDirectoryClick(event) {
            const target = event.target;

            if (target.closest('.section-header')) {
                handleSectionToggle(event);
                return;
            }

            const editBtn = target.closest('.edit-btn');
            if (editBtn) {
                const personId = parseInt(editBtn.dataset.id);
                const person = allPeople.find(p => p.id === personId);
                showModal('add-edit', { person, onSubmit: handleAdminFormSubmit });
                return;
            }

            const deleteBtn = target.closest('.delete-btn');
            if (deleteBtn) {
                const personId = parseInt(deleteBtn.dataset.id);
                const person = allPeople.find(p => p.id === personId);
                showModal('delete-confirm', { person, onConfirm: () => handleDeletePerson(personId) });
                return;
            }
            
            const tile = target.closest('.photo-tile');
            if (tile) {
                incrementForgettableCounter(tile);
                if (tile.dataset.personName === "Jake Kerner") {
                    let clickCount = parseInt(tile.dataset.clickCount || '0', 10);
                    clickCount++;
                    tile.dataset.clickCount = clickCount;
                    if (clickCount >= 3) {
                        showModal('request-change');
                        tile.dataset.clickCount = 0;
                    }
                }
            }
        }

        function handleDirectoryHover(event) {
            const tile = event.target.closest('.photo-tile');
            if(tile) {
                incrementForgettableCounter(tile);
            }
        }
        
        function handleSearch(term, forceOpen = false) {
            const searchTerm = term.toLowerCase();
            document.querySelectorAll('.collapsible-section').forEach(section => {
                let sectionHasMatch = false;
                const tiles = section.querySelectorAll('.photo-tile');
                
                if (tiles.length > 0) {
                    tiles.forEach(tile => {
                        const name = tile.dataset.personName.toLowerCase();
                        if (name.includes(searchTerm)) {
                            tile.style.display = 'block';
                            sectionHasMatch = true;
                        } else {
                            tile.style.display = 'none';
                        }
                    });

                    const content = section.querySelector('.section-content');
                    const icon = section.querySelector('.chevron-icon');

                    if (sectionHasMatch && searchTerm) {
                         content.style.maxHeight = content.scrollHeight + 'px';
                         icon.classList.add('rotate-180');
                         section.setAttribute('data-open', 'true');
                    } else if (!forceOpen) { // Don't close if we're not forcing a state
                        content.style.maxHeight = '0px';
                        icon.classList.remove('rotate-180');
                        section.setAttribute('data-open', 'false');
                    }
                }
            });
        }

        function resetToStep1() {
            userToVerify = null;
            isAdmin = false;
            sessionForgetfulWinner = null;
            sessionForgettableWinner = null;
            adminControls.classList.add('hidden');
            searchInput.value = '';
            handleSearch('');
            closeModal();
            switchView(verifyStep1);
        }

        // --- EVENT LISTENERS ---
        nameForm.addEventListener('submit', handleNameSubmit);
        logoutButton.addEventListener('click', resetToStep1);
        addPersonBtn.addEventListener('click', () => showModal('add-edit', { onSubmit: handleAdminFormSubmit }));
        backToStep1Button.addEventListener('click', resetToStep1);
        directoryContent.addEventListener('click', handleDirectoryClick);
        directoryContent.addEventListener('mouseover', handleDirectoryHover);
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        
        // --- INITIALIZATION ---
        switchView(verifyStep1);
    </script>
</body>
</html>
